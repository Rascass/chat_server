<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="clients_mapper">
    <select id="getById" resultMap="clients_map">
        SELECT Sessions.id as s_id, Clients.id as c_id, start, port, isActive, ip, host,
        sessionToken, clientToken, login, passwordHash
        FROM Clients
        LEFT JOIN SessionClients
        ON SessionClients.clientId = Clients.id
        LEFT JOIN Sessions
        ON SessionClients.sessionId = Sessions.id
        WHERE Clients.id=#{id}
    </select>
    <select id="get" resultMap="clients_map">
        SELECT Sessions.id as s_id, Clients.id as c_id, start, port, isActive, ip, host,
        sessionToken, clientToken, login, passwordHash
        FROM Clients
        LEFT JOIN SessionClients
        ON SessionClients.clientId = Clients.id
        LEFT JOIN Sessions
        ON SessionClients.sessionId = Sessions.id
    </select>
    <delete id="deleteById">
        DELETE FROM Clients WHERE Clients.id=#{id}
    </delete>
    <delete id="deleteFromJunctionById">
        DELETE FROM SessionClients WHERE SessionClients.clientId=#{id}
    </delete>
    <insert id="create">
        INSERT INTO Clients(id, clientToken, login, passwordHash)
        VALUES(#{id}, #{clientToken}, #{login}, #{password})
    </insert>
    <insert id="bind">
        INSERT INTO SessionClients(clientId, sessionId) VALUES
        <foreach collection="sessionList" item="item" open="(" separator="," close=")">
            #{id},
            #{item.id}
        </foreach>
    </insert>
    <update id="update">
        UPDATE Clients SET
        clientToken=#{clientToken},
        login=#{login},
        passwordHash=#{password}
        WHERE id=#{id}
    </update>

    <resultMap id="clients_map" type="model.Client" autoMapping="false">
        <id property="id" column="c_id"/>
        <result property="clientToken" column="clientToken"/>
        <result property="login" column="login"/>
        <result property="password" column="passwordHash"/>
        <collection property="sessionList" ofType="model.Session"/>
    </resultMap>
</mapper>